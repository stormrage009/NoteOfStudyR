<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.436">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>R语言学习笔记-IntroR - 7&nbsp; 统计建模</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<link href="./07-data-cleaning-feature.html" rel="next">
<link href="./05-ggplot2.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link id="quarto-text-highlighting-styles" href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">统计建模</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R语言学习笔记-IntroR</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">前言</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">basic</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-data-structrue.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">数据结构</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-rex.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">数据结构-时间序列+正则表达式</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">funciton&amp;loop</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-loop-purrr.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">循环和purrr</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-function.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">自定义函数</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">advanced</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-data-manipulation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">数据操作</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-ggplot2.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">ggolot2绘图</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-Statistical-modeling.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">统计建模</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-data-cleaning-feature.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">数据清洗和特征工程</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-rmarkdown-package.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">文档交流、R包开发及其他</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-descriptive-statistics.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">描述性统计</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-parameter-estimation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">参数估计</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-Hypothesis-testing.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">假设检验</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-regression.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">回归分析</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21-references.html" class="sidebar-item-text sidebar-link">参考文献</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">Appendices</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20-other-packages.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">其它有趣的包</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22-appendix.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">R Markdown</span></a>
  </div>
</li>
    </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#broom包整合模型结果" id="toc-broom包整合模型结果" class="nav-link active" data-scroll-target="#broom包整合模型结果"> <span class="header-section-number">7.1</span> <code>broom</code>包整合模型结果</a></li>
  <li><a href="#modelr包辅助建模" id="toc-modelr包辅助建模" class="nav-link" data-scroll-target="#modelr包辅助建模"> <span class="header-section-number">7.2</span> <code>modelr</code>包辅助建模</a>
  <ul class="collapse">
  <li><a href="#重抽样statistical-modeling-1-resample_" id="toc-重抽样statistical-modeling-1-resample_" class="nav-link" data-scroll-target="#重抽样statistical-modeling-1-resample_"> <span class="header-section-number">7.2.1</span> 重抽样 <code>resample_*()</code>：</a></li>
  <li><a href="#模型性能度量函数" id="toc-模型性能度量函数" class="nav-link" data-scroll-target="#模型性能度量函数"> <span class="header-section-number">7.2.2</span> 模型性能度量函数</a></li>
  <li><a href="#生成模型数据" id="toc-生成模型数据" class="nav-link" data-scroll-target="#生成模型数据"> <span class="header-section-number">7.2.3</span> 生成模型数据</a></li>
  <li><a href="#增加预测值列残差列" id="toc-增加预测值列残差列" class="nav-link" data-scroll-target="#增加预测值列残差列"> <span class="header-section-number">7.2.4</span> 增加预测值列、残差列</a></li>
  </ul></li>
  <li><a href="#案例110折交叉验证" id="toc-案例110折交叉验证" class="nav-link" data-scroll-target="#案例110折交叉验证"> <span class="header-section-number">7.3</span> 案例1，10折交叉验证</a></li>
  <li><a href="#批量建模" id="toc-批量建模" class="nav-link" data-scroll-target="#批量建模"> <span class="header-section-number">7.4</span> 批量建模</a>
  <ul class="collapse">
  <li><a href="#使用嵌套数据框purrrmap方式" id="toc-使用嵌套数据框purrrmap方式" class="nav-link" data-scroll-target="#使用嵌套数据框purrrmap方式"> <span class="header-section-number">7.4.1</span> 使用嵌套数据框+<code>purrr::map</code>方式</a></li>
  </ul></li>
  <li><a href="#利用rowwise技术" id="toc-利用rowwise技术" class="nav-link" data-scroll-target="#利用rowwise技术"> <span class="header-section-number">7.5</span> 利用rowwise技术</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title d-none d-lg-block"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">统计建模</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<ul>
<li><p>使用<code>broom</code>包实现将模型输出结果转化为整洁且列名规范一致的tibble，方面后续工作取用</p></li>
<li><p>再与<code>tidyr::nest()/unest()</code>以及<code>purrr::map()</code>连用，实现批量建模和整合模型结果的效果</p></li>
</ul>
<section id="broom包整合模型结果" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="broom包整合模型结果"><span class="header-section-number">7.1</span> <code>broom</code>包整合模型结果</h2>
<ol type="1">
<li><code>tidy()</code>：模型系数估计及其统计量</li>
</ol>
<ul>
<li><p>返回结果tibble的每一行均具有明确含义的项目</p></li>
<li><p>各列包括：</p>
<ul>
<li>term：回归或模型中要估计的项</li>
<li>estimate：参数估计值</li>
<li>statistic：检验统计量</li>
<li>p.value：检验统计量的p值</li>
<li>conf.low，conf.high：estimate的置信区间</li>
<li>df：自由度</li>
</ul></li>
</ul>
<ol start="2" type="1">
<li><code>glance()</code>：模型诊断信息</li>
</ol>
<p>返回一行的tilbble，各列是模型针对信息：</p>
<ul>
<li><p>r.squared: <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>R</mi><mn>2</mn></msup><annotation encoding="application/x-tex">R^2</annotation></semantics></math></p></li>
<li><p>adj.r.squared：根据自由度修正的<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>R</mi><mn>2</mn></msup><annotation encoding="application/x-tex">R^2</annotation></semantics></math></p></li>
<li><p>sigma：残差标准差估计值</p></li>
<li><p>AIC，BIC：信息准则</p></li>
</ul>
<ol start="3" type="1">
<li><code>augment()</code>：增加预测值列、残差列等</li>
</ol>
<ul>
<li><p><code>augment(model, data, newdata)</code>：如果data参数丢失，则不包含原始数据；如果设置newdata，则只针对新数据。</p></li>
<li><p>返回结果tibble的每一行都对应原始数据或新数据的一行</p></li>
<li><p>新增加的列包括：</p>
<ul>
<li><code>.fitted</code>：预测值，与原始数据同量纲</li>
<li><code>.resid</code>：残差，真实值与预测值的差</li>
<li><code>.cluster</code>：聚类结果</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching packages ─────────────────────────────────────── tidyverse 1.3.1 ──</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ ggplot2 3.3.6     ✔ purrr   0.3.4
✔ tibble  3.1.7     ✔ dplyr   1.0.9
✔ tidyr   1.2.0     ✔ stringr 1.4.0
✔ readr   2.1.2     ✔ forcats 0.5.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> wt, <span class="at">data =</span> mtcars)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  term        estimate std.error statistic  p.value
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1 (Intercept)    37.3      1.88      19.9  8.24e-19
2 wt             -5.34     0.559     -9.56 1.29e-10</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glance</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 12
  r.squared adj.r.squared sigma statistic  p.value    df logLik   AIC   BIC
      &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     0.753         0.745  3.05      91.4 1.29e-10     1  -80.0  166.  170.
# … with 3 more variables: deviance &lt;dbl&gt;, df.residual &lt;int&gt;, nobs &lt;int&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">augment</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 32 × 9
   .rownames           mpg    wt .fitted .resid   .hat .sigma .cooksd .std.resid
   &lt;chr&gt;             &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;
 1 Mazda RX4          21    2.62    23.3 -2.28  0.0433   3.07 1.33e-2    -0.766 
 2 Mazda RX4 Wag      21    2.88    21.9 -0.920 0.0352   3.09 1.72e-3    -0.307 
 3 Datsun 710         22.8  2.32    24.9 -2.09  0.0584   3.07 1.54e-2    -0.706 
 4 Hornet 4 Drive     21.4  3.22    20.1  1.30  0.0313   3.09 3.02e-3     0.433 
 5 Hornet Sportabout  18.7  3.44    18.9 -0.200 0.0329   3.10 7.60e-5    -0.0668
 6 Valiant            18.1  3.46    18.8 -0.693 0.0332   3.10 9.21e-4    -0.231 
 7 Duster 360         14.3  3.57    18.2 -3.91  0.0354   3.01 3.13e-2    -1.31  
 8 Merc 240D          24.4  3.19    20.2  4.16  0.0313   3.00 3.11e-2     1.39  
 9 Merc 230           22.8  3.15    20.5  2.35  0.0314   3.07 9.96e-3     0.784 
10 Merc 280           19.2  3.44    18.9  0.300 0.0329   3.10 1.71e-4     0.100 
# … with 22 more rows</code></pre>
</div>
</div>
<p><em>有了以上信息，我们就可以方便的进行数据筛选或者绘图</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">augment</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> wt, <span class="at">y =</span> mpg)) <span class="sc">+</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> .fitted), <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">xend =</span> wt, <span class="at">yend =</span> .fitted),</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="06-Statistical-modeling_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">augment</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ggplot</span>(<span class="fu">aes</span>(wt, .resid)) <span class="sc">+</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="06-Statistical-modeling_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="modelr包辅助建模" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="modelr包辅助建模"><span class="header-section-number">7.2</span> <code>modelr</code>包辅助建模</h2>
<p><code>modelr</code>包提供一系列辅助建模的函数，便于在<code>tidyverse</code>框架下辅助建模教学。</p>
<section id="重抽样statistical-modeling-1-resample_" class="level3" data-number="7.2.1">
<h3 data-number="7.2.1" class="anchored" data-anchor-id="重抽样statistical-modeling-1-resample_"><span class="header-section-number">7.2.1</span> 重抽样<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> <code>resample_*()</code>：</h3>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Danger
</div>
</div>
<div class="callout-body-container callout-body">
<p>常用的重抽样方法有：简单重抽样（Holdout），自助重抽样（Bootstrap），交叉验证重抽样（Cross Validation），置换重抽样（Permutation）</p>
</div>
</div>
<p><code>resample_*()</code>系列函数的具体用法和参数如下：</p>
<ul>
<li><p><code>resample(data, idx)</code>：根据整数向量idx从数据集data中重抽样。</p></li>
<li><p><code>resample_partition(data, p)</code>：生成一个简单重抽样，按概率p对数据集进行划分。常用于划分训练集和测试集。</p></li>
<li><p><code>resample_bootstrap(data)</code>：生成一个自助重抽样。类似的，<code>bootstrap(data, n)</code>则生成n个自助重抽样。</p></li>
<li><p><code>cross_kfold(data, k)</code>：生成k折交叉验证重抽样。类似的：</p>
<ul>
<li><code>cross_loo(data)</code>：生成留一交叉验证重抽样</li>
<li><code>cross_mc(data, n, test)</code>：按测试集占比test，生成n对蒙特卡洛交叉验证</li>
</ul></li>
<li><p><code>resample_permutaiton(data, columns)</code>：按列生成1个置换重抽样，类似的，<code>permutation(data, n, columns)</code>则生成n个置换重抽样。</p></li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Danger
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>为避免低效操作数据，重抽样的结果都是保存原数据的指针。</p></li>
<li><p>重抽样数据集均存放在返回结果的列表列，借助<code>map()</code>系列函数可以方便的进行批量建模。</p></li>
<li><p>每个重抽样的数据集，利用<code>as.data.frame()</code>或<code>as_tibble()</code>函数可以转化为数据框，也可以不用转换而直接应用于模型函数</p></li>
</ol>
</div>
</div>
</section>
<section id="模型性能度量函数" class="level3" data-number="7.2.2">
<h3 data-number="7.2.2" class="anchored" data-anchor-id="模型性能度量函数"><span class="header-section-number">7.2.2</span> 模型性能度量函数</h3>
<p>我们通常使用一些统计量对所构建模型的精度进行度量，常用的有：</p>
<ul>
<li><p>rmse(model, data)：均方根误差</p></li>
<li><p>mse(model, data)：均方误差</p></li>
<li><p>mae(model, data)：平均绝对误差</p></li>
<li><p>qae(model, data, probs)：分位数绝对误差</p></li>
<li><p>mape(model, data)：平均绝对百分比误差</p></li>
<li><p>rsae(model, data)：绝对误差相对和</p></li>
<li><p>rsquare(model, data)：<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>R</mi><mn>2</mn></msup><annotation encoding="application/x-tex">R^2</annotation></semantics></math></p></li>
</ul>
</section>
<section id="生成模型数据" class="level3" data-number="7.2.3">
<h3 data-number="7.2.3" class="anchored" data-anchor-id="生成模型数据"><span class="header-section-number">7.2.3</span> 生成模型数据</h3>
<ul>
<li><p>seq_range(x, n)：根据向量x值范围生成等间隔序列。</p></li>
<li><p>data_grid(data, f1, f2)： 生成唯一值的所有组合。</p></li>
<li><p>model_matrix()： 生成模型（设计矩阵），特别是用于虚拟变量梳理</p></li>
</ul>
</section>
<section id="增加预测值列残差列" class="level3" data-number="7.2.4">
<h3 data-number="7.2.4" class="anchored" data-anchor-id="增加预测值列残差列"><span class="header-section-number">7.2.4</span> 增加预测值列、残差列</h3>
<ul>
<li><p>add_predictions()</p></li>
<li><p>add_residuals()</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
载入程辑包：'modelr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:broom':

    bootstrap</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>ex <span class="ot">&lt;-</span> <span class="fu">resample_partition</span>(mtcars, <span class="fu">c</span>(<span class="at">test =</span> <span class="fl">0.3</span>, <span class="at">train =</span> <span class="fl">0.7</span>))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> wt, <span class="at">data =</span> ex<span class="sc">$</span>train)  <span class="co"># 建立线性模型</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rmse</span>(model, ex<span class="sc">$</span>test)  <span class="co"># 利用测试集计算构建模型的均方根误差</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.773909</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> wt <span class="sc">+</span> cyl <span class="sc">+</span> vs, <span class="at">data =</span> mtcars)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data_grid</span>(mtcars, <span class="at">wt =</span> <span class="fu">seq_range</span>(wt, <span class="dv">10</span>), cyl, vs) <span class="sc">%&gt;%</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">add_predictions</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 60 × 4
      wt   cyl    vs  pred
   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1  1.51     4     0  28.4
 2  1.51     4     1  28.9
 3  1.51     6     0  25.6
 4  1.51     6     1  26.2
 5  1.51     8     0  22.9
 6  1.51     8     1  23.4
 7  1.95     4     0  27.0
 8  1.95     4     1  27.5
 9  1.95     6     0  24.2
10  1.95     6     1  24.8
# … with 50 more rows</code></pre>
</div>
</div>
</section>
</section>
<section id="案例110折交叉验证" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="案例110折交叉验证"><span class="header-section-number">7.3</span> 案例1，10折交叉验证</h2>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Danger
</div>
</div>
<div class="callout-body-container callout-body">
<p>通常将数据集划分为训练集（90%）和测试集（10%），在训练集上训练一个模型，在测试机上评估模型效果。</p>
<p>如果只这样做一轮的话，模型的效果可能具有偶然性，对数据集利用的也不够充分。k折交叉验证是克服该缺陷的更好做法。</p>
</div>
</div>
<p>10折交叉验证，就是将数据集随机分成10份，分别以其中1份为测试集，其余9份为训练集，组成10组数据，训练10个模型，评估10次模型效果，取平均作为最终模型效果。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 生成10折交叉验证的数据</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>cv10 <span class="ot">&lt;-</span> <span class="fu">crossv_kfold</span>(mtcars, <span class="dv">10</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>cv10  <span class="co"># 结果为10行的嵌套数据框，分对对应10组训练集和测试集</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
   train                test                .id  
   &lt;named list&gt;         &lt;named list&gt;        &lt;chr&gt;
 1 &lt;resample [28 x 11]&gt; &lt;resample [4 x 11]&gt; 01   
 2 &lt;resample [28 x 11]&gt; &lt;resample [4 x 11]&gt; 02   
 3 &lt;resample [29 x 11]&gt; &lt;resample [3 x 11]&gt; 03   
 4 &lt;resample [29 x 11]&gt; &lt;resample [3 x 11]&gt; 04   
 5 &lt;resample [29 x 11]&gt; &lt;resample [3 x 11]&gt; 05   
 6 &lt;resample [29 x 11]&gt; &lt;resample [3 x 11]&gt; 06   
 7 &lt;resample [29 x 11]&gt; &lt;resample [3 x 11]&gt; 07   
 8 &lt;resample [29 x 11]&gt; &lt;resample [3 x 11]&gt; 08   
 9 &lt;resample [29 x 11]&gt; &lt;resample [3 x 11]&gt; 09   
10 &lt;resample [29 x 11]&gt; &lt;resample [3 x 11]&gt; 10   </code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 批量建模，使用map计算新列+赋值</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>cv10 <span class="sc">%&gt;%</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">models =</span> <span class="fu">map</span>(train, <span class="sc">~</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> wt, <span class="at">data =</span> .)),</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">rmse =</span> <span class="fu">map2_dbl</span>(models, test, rmse))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 5
   train                test                .id   models        rmse
   &lt;named list&gt;         &lt;named list&gt;        &lt;chr&gt; &lt;named list&gt; &lt;dbl&gt;
 1 &lt;resample [28 x 11]&gt; &lt;resample [4 x 11]&gt; 01    &lt;lm&gt;          1.31
 2 &lt;resample [28 x 11]&gt; &lt;resample [4 x 11]&gt; 02    &lt;lm&gt;          3.84
 3 &lt;resample [29 x 11]&gt; &lt;resample [3 x 11]&gt; 03    &lt;lm&gt;          3.11
 4 &lt;resample [29 x 11]&gt; &lt;resample [3 x 11]&gt; 04    &lt;lm&gt;          3.08
 5 &lt;resample [29 x 11]&gt; &lt;resample [3 x 11]&gt; 05    &lt;lm&gt;          2.18
 6 &lt;resample [29 x 11]&gt; &lt;resample [3 x 11]&gt; 06    &lt;lm&gt;          2.88
 7 &lt;resample [29 x 11]&gt; &lt;resample [3 x 11]&gt; 07    &lt;lm&gt;          4.38
 8 &lt;resample [29 x 11]&gt; &lt;resample [3 x 11]&gt; 08    &lt;lm&gt;          3.82
 9 &lt;resample [29 x 11]&gt; &lt;resample [3 x 11]&gt; 09    &lt;lm&gt;          1.84
10 &lt;resample [29 x 11]&gt; &lt;resample [3 x 11]&gt; 10    &lt;lm&gt;          4.48</code></pre>
</div>
</div>
</section>
<section id="批量建模" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="批量建模"><span class="header-section-number">7.4</span> 批量建模</h2>
<p><code>tidyverse</code>中两种简介的批量建模方式，两种方式均很巧妙。</p>
<ol type="1">
<li><p>使用嵌套数据框+<code>purrr::map</code>实现</p></li>
<li><p>使用<code>dplyr</code>包的<code>rowwise</code>技术。</p></li>
</ol>
<p>我们以<code>ecostats</code><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>数据集为例，分别来看</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"datas/ecostats.rda"</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>economics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 574 × 6
   date         pce    pop psavert uempmed unemploy
   &lt;date&gt;     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
 1 1967-07-01  507. 198712    12.6     4.5     2944
 2 1967-08-01  510. 198911    12.6     4.7     2945
 3 1967-09-01  516. 199113    11.9     4.6     2958
 4 1967-10-01  512. 199311    12.9     4.9     3143
 5 1967-11-01  517. 199498    12.8     4.7     3066
 6 1967-12-01  525. 199657    11.8     4.8     3018
 7 1968-01-01  531. 199808    11.7     5.1     2878
 8 1968-02-01  534. 199920    12.3     4.5     3001
 9 1968-03-01  544. 200056    11.7     4.1     2877
10 1968-04-01  544  200208    12.3     4.6     2709
# … with 564 more rows</code></pre>
</div>
</div>
<section id="使用嵌套数据框purrrmap方式" class="level3" data-number="7.4.1">
<h3 data-number="7.4.1" class="anchored" data-anchor-id="使用嵌套数据框purrrmap方式"><span class="header-section-number">7.4.1</span> 使用嵌套数据框+<code>purrr::map</code>方式</h3>
<ol type="1">
<li>想要对每个省份（数据子集）做重复操作</li>
</ol>
<ul>
<li><p>首先对数据框使用<code>group_nest()</code>对分组变量Region做分组嵌套，得到嵌套数据框，每组数据作为数据框嵌套到列表data</p></li>
<li><p>嵌套数据框的每一行是一个分组，表示一个省份的整个事件跨度内的所有观测（而不是某个单独时间点的观测）</p></li>
</ul>
<div class="cell">
<div class="cell-output-display">
<p><img src="images/nestdata.png" class="img-fluid" width="745"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>by_region <span class="ot">&lt;-</span> ecostats <span class="sc">%&gt;%</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">group_nest</span>(Region)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>by_region<span class="sc">$</span>data[[<span class="dv">1</span>]]  <span class="co"># 查看列表的第1个元素的内容</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 17 × 6
    Year Electricity Investment Consumption Population gdpPercap
   &lt;int&gt;       &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;
 1  2001        360.       893.        2739       6128     5716.
 2  2002        390.      1074.        2988       6144     6230.
 3  2003        445.      1419.        3312       6163     6990.
 4  2004        516.      1935.        3707       6228     8236.
 5  2005        582.      2525.        3870       6120     9274.
 6  2006        662.      3534.        4409       6110    10639.
 7  2007        769.      5088.        5276       6118    12981.
 8  2008        859.      6747.        6006       6135    15514.
 9  2009        952.      8991.        6829       6131    17721.
10  2010       1078.     11543.        8237       5957    22242.
11  2011       1221.     12456.       10055       5972    27269.
12  2012       1361.     15426.       10978       5978    30682.
13  2013       1528.     18622.       11618       5988    34375.
14  2014       1585.     21876.       12944       5997    37552.
15  2015       1640.     24386.       13941       6011    39646.
16  2016       1795.     27033.       15466       6033    43606.
17  2017       1921.     29275.       17141       6057    48995.</code></pre>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Danger
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>嵌套数据可以使用<code>unnest(by_region, data)</code>解除嵌套。</p></li>
<li><p>嵌套数据框的操作与普通数据框一直，如filter()、mutate()等函数均可以使用。</p></li>
</ol>
</div>
</div>
<ol start="3" type="1">
<li>批量建模</li>
</ol>
<ul>
<li>对嵌套数据框的data列进行建模，使用mutate()函数增加一列模型列用来存放每个省份对应的data拟合人均消费水平对人均GDP的线性回归模型。</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>by_region <span class="ot">&lt;-</span> by_region <span class="sc">%&gt;%</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">map</span>(data, <span class="sc">~</span> <span class="fu">lm</span>(Consumption <span class="sc">~</span> gdpPercap, .x)))</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>by_region</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 31 × 3
   Region               data model 
   &lt;chr&gt;  &lt;list&lt;tibble[,6]&gt;&gt; &lt;list&gt;
 1 安徽             [17 × 6] &lt;lm&gt;  
 2 北京             [17 × 6] &lt;lm&gt;  
 3 福建             [17 × 6] &lt;lm&gt;  
 4 甘肃             [17 × 6] &lt;lm&gt;  
 5 广东             [17 × 6] &lt;lm&gt;  
 6 广西             [17 × 6] &lt;lm&gt;  
 7 贵州             [17 × 6] &lt;lm&gt;  
 8 海南             [17 × 6] &lt;lm&gt;  
 9 河北             [17 × 6] &lt;lm&gt;  
10 河南             [17 × 6] &lt;lm&gt;  
# … with 21 more rows</code></pre>
</div>
</div>
<ul>
<li>继续修改列，在表中加入模型的判断统计量</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>by_region <span class="sc">%&gt;%</span> </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">rmse =</span> <span class="fu">map2_dbl</span>(model, data, rmse),</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">rsq =</span> <span class="fu">map2_dbl</span>(model, data, rsquare),</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">slop =</span> <span class="fu">map_dbl</span>(model, <span class="sc">~</span> <span class="fu">coef</span>(.x)[[<span class="dv">2</span>]]),</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">pval =</span> <span class="fu">map_dbl</span>(model, <span class="sc">~</span> <span class="fu">glance</span>(.x)<span class="sc">$</span>p.value))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 31 × 7
   Region               data model   rmse   rsq  slop     pval
   &lt;chr&gt;  &lt;list&lt;tibble[,6]&gt;&gt; &lt;list&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
 1 安徽             [17 × 6] &lt;lm&gt;    185. 0.998 0.327 2.36e-22
 2 北京             [17 × 6] &lt;lm&gt;   2005. 0.975 0.392 1.71e-13
 3 福建             [17 × 6] &lt;lm&gt;    415. 0.996 0.287 2.20e-19
 4 甘肃             [17 × 6] &lt;lm&gt;    600. 0.976 0.448 1.55e-13
 5 广东             [17 × 6] &lt;lm&gt;    592. 0.994 0.417 2.40e-18
 6 广西             [17 × 6] &lt;lm&gt;    270. 0.996 0.433 9.88e-20
 7 贵州             [17 × 6] &lt;lm&gt;    268. 0.996 0.424 1.17e-19
 8 海南             [17 × 6] &lt;lm&gt;   1173. 0.955 0.417 1.77e-11
 9 河北             [17 × 6] &lt;lm&gt;    497. 0.985 0.368 3.32e-15
10 河南             [17 × 6] &lt;lm&gt;    663. 0.981 0.375 2.33e-14
# … with 21 more rows</code></pre>
</div>
</div>
<ul>
<li><p>也可以配合 broom 包的函数 tidy(), glance(), augment() 批量、整洁地提取模型结果，这些结果仍是嵌套的列表列，若要完整地显示出来，需 要借助 unnest() 解除嵌套.</p>
<ul>
<li>提取模型系数估计及其统计量。</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>by_region <span class="sc">%&gt;%</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">result =</span> <span class="fu">map</span>(model, tidy)) <span class="sc">%&gt;%</span> </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(Region, result) <span class="sc">%&gt;%</span> </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">unnest</span>(<span class="at">cols =</span> result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 62 × 6
   Region term         estimate  std.error statistic  p.value
   &lt;chr&gt;  &lt;chr&gt;           &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
 1 安徽   (Intercept)   942.      89.4        10.5   2.47e- 8
 2 安徽   gdpPercap       0.327    0.00340    96.2   2.36e-22
 3 北京   (Intercept) -3824.    1301.         -2.94  1.01e- 2
 4 北京   gdpPercap       0.392    0.0160     24.4   1.71e-13
 5 福建   (Intercept)  1502.     214.          7.01  4.21e- 6
 6 福建   gdpPercap       0.287    0.00471    60.9   2.20e-19
 7 甘肃   (Intercept)  -168.     319.         -0.528 6.05e- 1
 8 甘肃   gdpPercap       0.448    0.0182     24.6   1.55e-13
 9 广东   (Intercept)  -487.     363.         -1.34  1.99e- 1
10 广东   gdpPercap       0.417    0.00804    51.9   2.40e-18
# … with 52 more rows</code></pre>
</div>
</div>
<ul>
<li>提取模型诊断信息</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>by_region <span class="sc">%&gt;%</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">result =</span> <span class="fu">map</span>(model, glance)) <span class="sc">%&gt;%</span> </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(Region, result) <span class="sc">%&gt;%</span> </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">unnest</span>(<span class="at">cols =</span> result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 31 × 13
   Region r.squared adj.r.squared sigma statistic  p.value    df logLik   AIC
   &lt;chr&gt;      &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1 安徽       0.998         0.998  197.     9260. 2.36e-22     1  -113.  232.
 2 北京       0.975         0.974 2134.      597. 1.71e-13     1  -153.  313.
 3 福建       0.996         0.996  441.     3713. 2.20e-19     1  -127.  259.
 4 甘肃       0.976         0.974  638.      605. 1.55e-13     1  -133.  272.
 5 广东       0.994         0.994  630.     2696. 2.40e-18     1  -133.  271.
 6 广西       0.996         0.996  287.     4133. 9.88e-20     1  -119.  245.
 7 贵州       0.996         0.996  286.     4038. 1.17e-19     1  -119.  244.
 8 海南       0.955         0.952 1249.      315. 1.77e-11     1  -144.  295.
 9 河北       0.985         0.985  529.     1019. 3.32e-15     1  -130.  265.
10 河南       0.981         0.980  706.      783. 2.33e-14     1  -135.  275.
# … with 21 more rows, and 4 more variables: BIC &lt;dbl&gt;, deviance &lt;dbl&gt;,
#   df.residual &lt;int&gt;, nobs &lt;int&gt;</code></pre>
</div>
</div>
<ul>
<li>批量增加预测值、残差列等</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>by_region <span class="sc">%&gt;%</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">result =</span> <span class="fu">map</span>(model, augment)) <span class="sc">%&gt;%</span> </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(Region, result) <span class="sc">%&gt;%</span> </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">unnest</span>(<span class="at">cols =</span> result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 527 × 9
   Region Consumption gdpPercap .fitted  .resid   .hat .sigma .cooksd .std.resid
   &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;
 1 安徽          2739     5716.   2811.  -72.5  0.140    203. 1.28e-2    -0.396 
 2 安徽          2988     6230.   2980.    8.49 0.135    204. 1.67e-4     0.0463
 3 安徽          3312     6990.   3228.   84.0  0.128    203. 1.53e-2     0.456 
 4 安徽          3707     8236.   3635.   71.7  0.117    203. 9.91e-3     0.387 
 5 安徽          3870     9274.   3975. -105.   0.109    202. 1.94e-2    -0.564 
 6 安徽          4409    10639.   4421.  -12.2  0.0986   204. 2.32e-4    -0.0651
 7 安徽          5276    12981.   5187.   89.0  0.0842   203. 1.02e-2     0.472 
 8 安徽          6006    15514.   6015.   -9.30 0.0722   204. 9.32e-5    -0.0490
 9 安徽          6829    17721.   6737.   92.0  0.0648   202. 8.07e-3     0.482 
10 安徽          8237    22242.   8216.   21.5  0.0588   204. 3.93e-4     0.112 
# … with 517 more rows</code></pre>
</div>
</div>
</section>
</section>
<section id="利用rowwise技术" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="利用rowwise技术"><span class="header-section-number">7.5</span> 利用rowwise技术</h2>
<p>rowwise按行方式操作数据，可以理解为一种特殊的分组：每一行为一组</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>by_region <span class="ot">&lt;-</span> ecostats <span class="sc">%&gt;%</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">nest_by</span>(Region)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>by_region  <span class="co"># 增加了按行惭怍的分组信息：Rowwise:Region</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 31 × 2
# Rowwise:  Region
   Region               data
   &lt;chr&gt;  &lt;list&lt;tibble[,6]&gt;&gt;
 1 安徽             [17 × 6]
 2 北京             [17 × 6]
 3 福建             [17 × 6]
 4 甘肃             [17 × 6]
 5 广东             [17 × 6]
 6 广西             [17 × 6]
 7 贵州             [17 × 6]
 8 海南             [17 × 6]
 9 河北             [17 × 6]
10 河南             [17 × 6]
# … with 21 more rows</code></pre>
</div>
</div>
<p><code>nest_by()</code>将一个省份的数据放在同一行中嵌套，正好契合rowwise的逻辑，即逐行的对每个嵌套的数据框进行建模和提取模型信息的操作，这些操作使用<code>mutate()</code>和<code>summarise()</code>连用来实现，前者会保持rowwise模式（计算结果行数保持不变），而后者相当于对每行结果做汇总，结果行数可变（变多，且结果不具有rowwise模式）。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>by_region <span class="ot">&lt;-</span> by_region <span class="sc">%&gt;%</span> </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">list</span>(<span class="fu">lm</span>(Consumption <span class="sc">~</span> gdpPercap, data)))</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>by_region</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 31 × 3
# Rowwise:  Region
   Region               data model 
   &lt;chr&gt;  &lt;list&lt;tibble[,6]&gt;&gt; &lt;list&gt;
 1 安徽             [17 × 6] &lt;lm&gt;  
 2 北京             [17 × 6] &lt;lm&gt;  
 3 福建             [17 × 6] &lt;lm&gt;  
 4 甘肃             [17 × 6] &lt;lm&gt;  
 5 广东             [17 × 6] &lt;lm&gt;  
 6 广西             [17 × 6] &lt;lm&gt;  
 7 贵州             [17 × 6] &lt;lm&gt;  
 8 海南             [17 × 6] &lt;lm&gt;  
 9 河北             [17 × 6] &lt;lm&gt;  
10 河南             [17 × 6] &lt;lm&gt;  
# … with 21 more rows</code></pre>
</div>
</div>
<p>批量建模后，使用模型列和数据列对模型的检验统计量进行计算:</p>
<ul>
<li>使用mutate:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>by_region <span class="sc">%&gt;%</span> </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">rmse =</span> <span class="fu">rmse</span>(model, data),</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">rsq =</span> <span class="fu">rsquare</span>(model, data),</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">slope =</span> <span class="fu">coef</span>(model)[[<span class="dv">2</span>]],</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">pval =</span> <span class="fu">glance</span>(model)<span class="sc">$</span>p.value</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>   )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 31 × 7
# Rowwise:  Region
   Region               data model   rmse   rsq slope     pval
   &lt;chr&gt;  &lt;list&lt;tibble[,6]&gt;&gt; &lt;list&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
 1 安徽             [17 × 6] &lt;lm&gt;    185. 0.998 0.327 2.36e-22
 2 北京             [17 × 6] &lt;lm&gt;   2005. 0.975 0.392 1.71e-13
 3 福建             [17 × 6] &lt;lm&gt;    415. 0.996 0.287 2.20e-19
 4 甘肃             [17 × 6] &lt;lm&gt;    600. 0.976 0.448 1.55e-13
 5 广东             [17 × 6] &lt;lm&gt;    592. 0.994 0.417 2.40e-18
 6 广西             [17 × 6] &lt;lm&gt;    270. 0.996 0.433 9.88e-20
 7 贵州             [17 × 6] &lt;lm&gt;    268. 0.996 0.424 1.17e-19
 8 海南             [17 × 6] &lt;lm&gt;   1173. 0.955 0.417 1.77e-11
 9 河北             [17 × 6] &lt;lm&gt;    497. 0.985 0.368 3.32e-15
10 河南             [17 × 6] &lt;lm&gt;    663. 0.981 0.375 2.33e-14
# … with 21 more rows</code></pre>
</div>
</div>
<ul>
<li>使用broom：</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>by_region <span class="sc">%&gt;%</span> </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarise</span>(<span class="fu">tidy</span>(model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Region'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 62 × 6
# Groups:   Region [31]
   Region term         estimate  std.error statistic  p.value
   &lt;chr&gt;  &lt;chr&gt;           &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
 1 安徽   (Intercept)   942.      89.4        10.5   2.47e- 8
 2 安徽   gdpPercap       0.327    0.00340    96.2   2.36e-22
 3 北京   (Intercept) -3824.    1301.         -2.94  1.01e- 2
 4 北京   gdpPercap       0.392    0.0160     24.4   1.71e-13
 5 福建   (Intercept)  1502.     214.          7.01  4.21e- 6
 6 福建   gdpPercap       0.287    0.00471    60.9   2.20e-19
 7 甘肃   (Intercept)  -168.     319.         -0.528 6.05e- 1
 8 甘肃   gdpPercap       0.448    0.0182     24.6   1.55e-13
 9 广东   (Intercept)  -487.     363.         -1.34  1.99e- 1
10 广东   gdpPercap       0.417    0.00804    51.9   2.40e-18
# … with 52 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>by_region <span class="sc">%&gt;%</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarise</span>(<span class="fu">glance</span>(model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Region'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 31 × 13
# Groups:   Region [31]
   Region r.squared adj.r.squared sigma statistic  p.value    df logLik   AIC
   &lt;chr&gt;      &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1 安徽       0.998         0.998  197.     9260. 2.36e-22     1  -113.  232.
 2 北京       0.975         0.974 2134.      597. 1.71e-13     1  -153.  313.
 3 福建       0.996         0.996  441.     3713. 2.20e-19     1  -127.  259.
 4 甘肃       0.976         0.974  638.      605. 1.55e-13     1  -133.  272.
 5 广东       0.994         0.994  630.     2696. 2.40e-18     1  -133.  271.
 6 广西       0.996         0.996  287.     4133. 9.88e-20     1  -119.  245.
 7 贵州       0.996         0.996  286.     4038. 1.17e-19     1  -119.  244.
 8 海南       0.955         0.952 1249.      315. 1.77e-11     1  -144.  295.
 9 河北       0.985         0.985  529.     1019. 3.32e-15     1  -130.  265.
10 河南       0.981         0.980  706.      783. 2.33e-14     1  -135.  275.
# … with 21 more rows, and 4 more variables: BIC &lt;dbl&gt;, deviance &lt;dbl&gt;,
#   df.residual &lt;int&gt;, nobs &lt;int&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>by_region <span class="sc">%&gt;%</span> </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarise</span>(<span class="fu">augment</span>(model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Region'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 527 × 9
# Groups:   Region [31]
   Region Consumption gdpPercap .fitted  .resid   .hat .sigma .cooksd .std.resid
   &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;
 1 安徽          2739     5716.   2811.  -72.5  0.140    203. 1.28e-2    -0.396 
 2 安徽          2988     6230.   2980.    8.49 0.135    204. 1.67e-4     0.0463
 3 安徽          3312     6990.   3228.   84.0  0.128    203. 1.53e-2     0.456 
 4 安徽          3707     8236.   3635.   71.7  0.117    203. 9.91e-3     0.387 
 5 安徽          3870     9274.   3975. -105.   0.109    202. 1.94e-2    -0.564 
 6 安徽          4409    10639.   4421.  -12.2  0.0986   204. 2.32e-4    -0.0651
 7 安徽          5276    12981.   5187.   89.0  0.0842   203. 1.02e-2     0.472 
 8 安徽          6006    15514.   6015.   -9.30 0.0722   204. 9.32e-5    -0.0490
 9 安徽          6829    17721.   6737.   92.0  0.0648   202. 8.07e-3     0.482 
10 安徽          8237    22242.   8216.   21.5  0.0588   204. 3.93e-4     0.112 
# … with 517 more rows</code></pre>
</div>
</div>
<p><a href=".todo">（分组）滚动回归</a></p>


<!-- -->

</section>
<section class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1" role="doc-endnote"><p>就是反复从数据集中抽取样本形成若干个”替代”数据集，用于统计推断或模型性能评估。<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>整理自国家统计局网站，包含 2001-2017 年我国 31 个省份的人口、居民消费水平、人均 GDP 等<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./05-ggplot2.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">ggolot2绘图</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./07-data-cleaning-feature.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">数据清洗和特征工程</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb53" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># 统计建模</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>使用<span class="in">`broom`</span>包实现将模型输出结果转化为整洁且列名规范一致的tibble，方面后续工作取用</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>再与<span class="in">`tidyr::nest()/unest()`</span>以及<span class="in">`purrr::map()`</span>连用，实现批量建模和整合模型结果的效果</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="fu">## `broom`包整合模型结果</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span><span class="in">`tidy()`</span>：模型系数估计及其统计量</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>返回结果tibble的每一行均具有明确含义的项目</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>各列包括：</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>term：回归或模型中要估计的项</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>estimate：参数估计值</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>statistic：检验统计量</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>p.value：检验统计量的p值</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>conf.low，conf.high：estimate的置信区间</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>df：自由度</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span><span class="in">`glance()`</span>：模型诊断信息</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>返回一行的tilbble，各列是模型针对信息：</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>r.squared: $R^2$</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>adj.r.squared：根据自由度修正的$R^2$</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>sigma：残差标准差估计值</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>AIC，BIC：信息准则</span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span><span class="in">`augment()`</span>：增加预测值列、残差列等</span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`augment(model, data, newdata)`</span>：如果data参数丢失，则不包含原始数据；如果设置newdata，则只针对新数据。</span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>返回结果tibble的每一行都对应原始数据或新数据的一行</span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>新增加的列包括：</span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="in">`.fitted`</span>：预测值，与原始数据同量纲</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="in">`.resid`</span>：残差，真实值与预测值的差</span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="in">`.cluster`</span>：聚类结果</span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> wt, <span class="at">data =</span> mtcars)</span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> </span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>()</span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> </span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glance</span>()</span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> </span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">augment</span>()</span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a>*有了以上信息，我们就可以方便的进行数据筛选或者绘图*</span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> </span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">augment</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb53-69"><a href="#cb53-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> wt, <span class="at">y =</span> mpg)) <span class="sc">+</span></span>
<span id="cb53-70"><a href="#cb53-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb53-71"><a href="#cb53-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> .fitted), <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb53-72"><a href="#cb53-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">xend =</span> wt, <span class="at">yend =</span> .fitted),</span>
<span id="cb53-73"><a href="#cb53-73" aria-hidden="true" tabindex="-1"></a>                 <span class="at">color =</span> <span class="st">"red"</span>)</span>
<span id="cb53-74"><a href="#cb53-74" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-75"><a href="#cb53-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-78"><a href="#cb53-78" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-79"><a href="#cb53-79" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> </span>
<span id="cb53-80"><a href="#cb53-80" aria-hidden="true" tabindex="-1"></a>   <span class="fu">augment</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb53-81"><a href="#cb53-81" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ggplot</span>(<span class="fu">aes</span>(wt, .resid)) <span class="sc">+</span></span>
<span id="cb53-82"><a href="#cb53-82" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb53-83"><a href="#cb53-83" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"blue"</span>)</span>
<span id="cb53-84"><a href="#cb53-84" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-85"><a href="#cb53-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-86"><a href="#cb53-86" aria-hidden="true" tabindex="-1"></a><span class="fu">## `modelr`包辅助建模</span></span>
<span id="cb53-87"><a href="#cb53-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-88"><a href="#cb53-88" aria-hidden="true" tabindex="-1"></a><span class="in">`modelr`</span>包提供一系列辅助建模的函数，便于在<span class="in">`tidyverse`</span>框架下辅助建模教学。</span>
<span id="cb53-89"><a href="#cb53-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-90"><a href="#cb53-90" aria-hidden="true" tabindex="-1"></a><span class="fu">### 重抽样[^statistical-modeling-1] `resample_*()`：</span></span>
<span id="cb53-91"><a href="#cb53-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-92"><a href="#cb53-92" aria-hidden="true" tabindex="-1"></a><span class="ot">[^statistical-modeling-1]: </span>就是反复从数据集中抽取样本形成若干个"替代"数据集，用于统计推断或模型性能评估。</span>
<span id="cb53-93"><a href="#cb53-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-94"><a href="#cb53-94" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb53-95"><a href="#cb53-95" aria-hidden="true" tabindex="-1"></a>常用的重抽样方法有：简单重抽样（Holdout），自助重抽样（Bootstrap），交叉验证重抽样（Cross Validation），置换重抽样（Permutation）</span>
<span id="cb53-96"><a href="#cb53-96" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb53-97"><a href="#cb53-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-98"><a href="#cb53-98" aria-hidden="true" tabindex="-1"></a><span class="in">`resample_*()`</span>系列函数的具体用法和参数如下：</span>
<span id="cb53-99"><a href="#cb53-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-100"><a href="#cb53-100" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`resample(data, idx)`</span>：根据整数向量idx从数据集data中重抽样。</span>
<span id="cb53-101"><a href="#cb53-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-102"><a href="#cb53-102" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`resample_partition(data, p)`</span>：生成一个简单重抽样，按概率p对数据集进行划分。常用于划分训练集和测试集。</span>
<span id="cb53-103"><a href="#cb53-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-104"><a href="#cb53-104" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`resample_bootstrap(data)`</span>：生成一个自助重抽样。类似的，<span class="in">`bootstrap(data, n)`</span>则生成n个自助重抽样。</span>
<span id="cb53-105"><a href="#cb53-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-106"><a href="#cb53-106" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`cross_kfold(data, k)`</span>：生成k折交叉验证重抽样。类似的：</span>
<span id="cb53-107"><a href="#cb53-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-108"><a href="#cb53-108" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="in">`cross_loo(data)`</span>：生成留一交叉验证重抽样</span>
<span id="cb53-109"><a href="#cb53-109" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="in">`cross_mc(data, n, test)`</span>：按测试集占比test，生成n对蒙特卡洛交叉验证</span>
<span id="cb53-110"><a href="#cb53-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-111"><a href="#cb53-111" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`resample_permutaiton(data, columns)`</span>：按列生成1个置换重抽样，类似的，<span class="in">`permutation(data, n, columns)`</span>则生成n个置换重抽样。</span>
<span id="cb53-112"><a href="#cb53-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-113"><a href="#cb53-113" aria-hidden="true" tabindex="-1"></a>::: {.callout-caution}</span>
<span id="cb53-114"><a href="#cb53-114" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>为避免低效操作数据，重抽样的结果都是保存原数据的指针。</span>
<span id="cb53-115"><a href="#cb53-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-116"><a href="#cb53-116" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>重抽样数据集均存放在返回结果的列表列，借助<span class="in">`map()`</span>系列函数可以方便的进行批量建模。</span>
<span id="cb53-117"><a href="#cb53-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-118"><a href="#cb53-118" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>每个重抽样的数据集，利用<span class="in">`as.data.frame()`</span>或<span class="in">`as_tibble()`</span>函数可以转化为数据框，也可以不用转换而直接应用于模型函数</span>
<span id="cb53-119"><a href="#cb53-119" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb53-120"><a href="#cb53-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-121"><a href="#cb53-121" aria-hidden="true" tabindex="-1"></a><span class="fu">### 模型性能度量函数</span></span>
<span id="cb53-122"><a href="#cb53-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-123"><a href="#cb53-123" aria-hidden="true" tabindex="-1"></a>我们通常使用一些统计量对所构建模型的精度进行度量，常用的有：</span>
<span id="cb53-124"><a href="#cb53-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-125"><a href="#cb53-125" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>rmse(model, data)：均方根误差</span>
<span id="cb53-126"><a href="#cb53-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-127"><a href="#cb53-127" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>mse(model, data)：均方误差</span>
<span id="cb53-128"><a href="#cb53-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-129"><a href="#cb53-129" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>mae(model, data)：平均绝对误差</span>
<span id="cb53-130"><a href="#cb53-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-131"><a href="#cb53-131" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>qae(model, data, probs)：分位数绝对误差</span>
<span id="cb53-132"><a href="#cb53-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-133"><a href="#cb53-133" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>mape(model, data)：平均绝对百分比误差</span>
<span id="cb53-134"><a href="#cb53-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-135"><a href="#cb53-135" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>rsae(model, data)：绝对误差相对和</span>
<span id="cb53-136"><a href="#cb53-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-137"><a href="#cb53-137" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>rsquare(model, data)：$R^2$</span>
<span id="cb53-138"><a href="#cb53-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-139"><a href="#cb53-139" aria-hidden="true" tabindex="-1"></a><span class="fu">### 生成模型数据</span></span>
<span id="cb53-140"><a href="#cb53-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-141"><a href="#cb53-141" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>seq_range(x, n)：根据向量x值范围生成等间隔序列。</span>
<span id="cb53-142"><a href="#cb53-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-143"><a href="#cb53-143" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>data_grid(data, f1, f2)： 生成唯一值的所有组合。</span>
<span id="cb53-144"><a href="#cb53-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-145"><a href="#cb53-145" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>model_matrix()： 生成模型（设计矩阵），特别是用于虚拟变量梳理</span>
<span id="cb53-146"><a href="#cb53-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-147"><a href="#cb53-147" aria-hidden="true" tabindex="-1"></a><span class="fu">### 增加预测值列、残差列</span></span>
<span id="cb53-148"><a href="#cb53-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-149"><a href="#cb53-149" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>add_predictions()</span>
<span id="cb53-150"><a href="#cb53-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-151"><a href="#cb53-151" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>add_residuals()</span>
<span id="cb53-152"><a href="#cb53-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-155"><a href="#cb53-155" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-156"><a href="#cb53-156" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelr)</span>
<span id="cb53-157"><a href="#cb53-157" aria-hidden="true" tabindex="-1"></a>ex <span class="ot">&lt;-</span> <span class="fu">resample_partition</span>(mtcars, <span class="fu">c</span>(<span class="at">test =</span> <span class="fl">0.3</span>, <span class="at">train =</span> <span class="fl">0.7</span>))</span>
<span id="cb53-158"><a href="#cb53-158" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> wt, <span class="at">data =</span> ex<span class="sc">$</span>train)  <span class="co"># 建立线性模型</span></span>
<span id="cb53-159"><a href="#cb53-159" aria-hidden="true" tabindex="-1"></a><span class="fu">rmse</span>(model, ex<span class="sc">$</span>test)  <span class="co"># 利用测试集计算构建模型的均方根误差</span></span>
<span id="cb53-160"><a href="#cb53-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-161"><a href="#cb53-161" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> wt <span class="sc">+</span> cyl <span class="sc">+</span> vs, <span class="at">data =</span> mtcars)</span>
<span id="cb53-162"><a href="#cb53-162" aria-hidden="true" tabindex="-1"></a><span class="fu">data_grid</span>(mtcars, <span class="at">wt =</span> <span class="fu">seq_range</span>(wt, <span class="dv">10</span>), cyl, vs) <span class="sc">%&gt;%</span> </span>
<span id="cb53-163"><a href="#cb53-163" aria-hidden="true" tabindex="-1"></a>   <span class="fu">add_predictions</span>(model)</span>
<span id="cb53-164"><a href="#cb53-164" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-165"><a href="#cb53-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-166"><a href="#cb53-166" aria-hidden="true" tabindex="-1"></a><span class="fu">## 案例1，10折交叉验证</span></span>
<span id="cb53-167"><a href="#cb53-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-168"><a href="#cb53-168" aria-hidden="true" tabindex="-1"></a>::: {.callout-caution}</span>
<span id="cb53-169"><a href="#cb53-169" aria-hidden="true" tabindex="-1"></a>通常将数据集划分为训练集（90%）和测试集（10%），在训练集上训练一个模型，在测试机上评估模型效果。</span>
<span id="cb53-170"><a href="#cb53-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-171"><a href="#cb53-171" aria-hidden="true" tabindex="-1"></a>如果只这样做一轮的话，模型的效果可能具有偶然性，对数据集利用的也不够充分。k折交叉验证是克服该缺陷的更好做法。</span>
<span id="cb53-172"><a href="#cb53-172" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb53-173"><a href="#cb53-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-174"><a href="#cb53-174" aria-hidden="true" tabindex="-1"></a>10折交叉验证，就是将数据集随机分成10份，分别以其中1份为测试集，其余9份为训练集，组成10组数据，训练10个模型，评估10次模型效果，取平均作为最终模型效果。</span>
<span id="cb53-175"><a href="#cb53-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-178"><a href="#cb53-178" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-179"><a href="#cb53-179" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb53-180"><a href="#cb53-180" aria-hidden="true" tabindex="-1"></a><span class="co"># 生成10折交叉验证的数据</span></span>
<span id="cb53-181"><a href="#cb53-181" aria-hidden="true" tabindex="-1"></a>cv10 <span class="ot">&lt;-</span> <span class="fu">crossv_kfold</span>(mtcars, <span class="dv">10</span>)</span>
<span id="cb53-182"><a href="#cb53-182" aria-hidden="true" tabindex="-1"></a>cv10  <span class="co"># 结果为10行的嵌套数据框，分对对应10组训练集和测试集</span></span>
<span id="cb53-183"><a href="#cb53-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-184"><a href="#cb53-184" aria-hidden="true" tabindex="-1"></a><span class="co"># 批量建模，使用map计算新列+赋值</span></span>
<span id="cb53-185"><a href="#cb53-185" aria-hidden="true" tabindex="-1"></a>cv10 <span class="sc">%&gt;%</span> </span>
<span id="cb53-186"><a href="#cb53-186" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">models =</span> <span class="fu">map</span>(train, <span class="sc">~</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> wt, <span class="at">data =</span> .)),</span>
<span id="cb53-187"><a href="#cb53-187" aria-hidden="true" tabindex="-1"></a>          <span class="at">rmse =</span> <span class="fu">map2_dbl</span>(models, test, rmse))</span>
<span id="cb53-188"><a href="#cb53-188" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-189"><a href="#cb53-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-190"><a href="#cb53-190" aria-hidden="true" tabindex="-1"></a><span class="fu">## 批量建模</span></span>
<span id="cb53-191"><a href="#cb53-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-192"><a href="#cb53-192" aria-hidden="true" tabindex="-1"></a><span class="in">`tidyverse`</span>中两种简介的批量建模方式，两种方式均很巧妙。</span>
<span id="cb53-193"><a href="#cb53-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-194"><a href="#cb53-194" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>使用嵌套数据框+<span class="in">`purrr::map`</span>实现</span>
<span id="cb53-195"><a href="#cb53-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-196"><a href="#cb53-196" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>使用<span class="in">`dplyr`</span>包的<span class="in">`rowwise`</span>技术。</span>
<span id="cb53-197"><a href="#cb53-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-198"><a href="#cb53-198" aria-hidden="true" tabindex="-1"></a>我们以<span class="in">`ecostats`</span><span class="ot">[^statistical-modeling-2]</span>数据集为例，分别来看</span>
<span id="cb53-199"><a href="#cb53-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-200"><a href="#cb53-200" aria-hidden="true" tabindex="-1"></a><span class="ot">[^statistical-modeling-2]: </span>整理自国家统计局网站，包含 2001-2017 年我国 31 个省份的人口、居民消费水平、人均 GDP 等</span>
<span id="cb53-201"><a href="#cb53-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-204"><a href="#cb53-204" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-205"><a href="#cb53-205" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"datas/ecostats.rda"</span>)</span>
<span id="cb53-206"><a href="#cb53-206" aria-hidden="true" tabindex="-1"></a>economics</span>
<span id="cb53-207"><a href="#cb53-207" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-208"><a href="#cb53-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-209"><a href="#cb53-209" aria-hidden="true" tabindex="-1"></a><span class="fu">### 使用嵌套数据框+`purrr::map`方式</span></span>
<span id="cb53-210"><a href="#cb53-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-211"><a href="#cb53-211" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>想要对每个省份（数据子集）做重复操作</span>
<span id="cb53-212"><a href="#cb53-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-213"><a href="#cb53-213" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>首先对数据框使用<span class="in">`group_nest()`</span>对分组变量Region做分组嵌套，得到嵌套数据框，每组数据作为数据框嵌套到列表data</span>
<span id="cb53-214"><a href="#cb53-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-215"><a href="#cb53-215" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>嵌套数据框的每一行是一个分组，表示一个省份的整个事件跨度内的所有观测（而不是某个单独时间点的观测）</span>
<span id="cb53-216"><a href="#cb53-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-217"><a href="#cb53-217" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo = FALSE}</span></span>
<span id="cb53-218"><a href="#cb53-218" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"images/nestdata.png"</span>, <span class="at">dpi =</span> <span class="cn">FALSE</span>)</span>
<span id="cb53-219"><a href="#cb53-219" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-220"><a href="#cb53-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-223"><a href="#cb53-223" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-224"><a href="#cb53-224" aria-hidden="true" tabindex="-1"></a>by_region <span class="ot">&lt;-</span> ecostats <span class="sc">%&gt;%</span> </span>
<span id="cb53-225"><a href="#cb53-225" aria-hidden="true" tabindex="-1"></a>   <span class="fu">group_nest</span>(Region)</span>
<span id="cb53-226"><a href="#cb53-226" aria-hidden="true" tabindex="-1"></a>by_region<span class="sc">$</span>data[[<span class="dv">1</span>]]  <span class="co"># 查看列表的第1个元素的内容</span></span>
<span id="cb53-227"><a href="#cb53-227" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-228"><a href="#cb53-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-229"><a href="#cb53-229" aria-hidden="true" tabindex="-1"></a>::: {.callout-caution}</span>
<span id="cb53-230"><a href="#cb53-230" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>嵌套数据可以使用<span class="in">`unnest(by_region, data)`</span>解除嵌套。</span>
<span id="cb53-231"><a href="#cb53-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-232"><a href="#cb53-232" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>嵌套数据框的操作与普通数据框一直，如filter()、mutate()等函数均可以使用。</span>
<span id="cb53-233"><a href="#cb53-233" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb53-234"><a href="#cb53-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-235"><a href="#cb53-235" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>批量建模</span>
<span id="cb53-236"><a href="#cb53-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-237"><a href="#cb53-237" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>对嵌套数据框的data列进行建模，使用mutate()函数增加一列模型列用来存放每个省份对应的data拟合人均消费水平对人均GDP的线性回归模型。</span>
<span id="cb53-238"><a href="#cb53-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-241"><a href="#cb53-241" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-242"><a href="#cb53-242" aria-hidden="true" tabindex="-1"></a>by_region <span class="ot">&lt;-</span> by_region <span class="sc">%&gt;%</span> </span>
<span id="cb53-243"><a href="#cb53-243" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">map</span>(data, <span class="sc">~</span> <span class="fu">lm</span>(Consumption <span class="sc">~</span> gdpPercap, .x)))</span>
<span id="cb53-244"><a href="#cb53-244" aria-hidden="true" tabindex="-1"></a>by_region</span>
<span id="cb53-245"><a href="#cb53-245" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-246"><a href="#cb53-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-247"><a href="#cb53-247" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>继续修改列，在表中加入模型的判断统计量</span>
<span id="cb53-248"><a href="#cb53-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-251"><a href="#cb53-251" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-252"><a href="#cb53-252" aria-hidden="true" tabindex="-1"></a>by_region <span class="sc">%&gt;%</span> </span>
<span id="cb53-253"><a href="#cb53-253" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">rmse =</span> <span class="fu">map2_dbl</span>(model, data, rmse),</span>
<span id="cb53-254"><a href="#cb53-254" aria-hidden="true" tabindex="-1"></a>          <span class="at">rsq =</span> <span class="fu">map2_dbl</span>(model, data, rsquare),</span>
<span id="cb53-255"><a href="#cb53-255" aria-hidden="true" tabindex="-1"></a>          <span class="at">slop =</span> <span class="fu">map_dbl</span>(model, <span class="sc">~</span> <span class="fu">coef</span>(.x)[[<span class="dv">2</span>]]),</span>
<span id="cb53-256"><a href="#cb53-256" aria-hidden="true" tabindex="-1"></a>          <span class="at">pval =</span> <span class="fu">map_dbl</span>(model, <span class="sc">~</span> <span class="fu">glance</span>(.x)<span class="sc">$</span>p.value))</span>
<span id="cb53-257"><a href="#cb53-257" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-258"><a href="#cb53-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-259"><a href="#cb53-259" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>也可以配合 broom 包的函数 tidy(), glance(), augment() 批量、整洁地提取模型结果，这些结果仍是嵌套的列表列，若要完整地显示出来，需 要借助 unnest() 解除嵌套.</span>
<span id="cb53-260"><a href="#cb53-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-261"><a href="#cb53-261" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>提取模型系数估计及其统计量。</span>
<span id="cb53-262"><a href="#cb53-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-265"><a href="#cb53-265" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-266"><a href="#cb53-266" aria-hidden="true" tabindex="-1"></a>by_region <span class="sc">%&gt;%</span> </span>
<span id="cb53-267"><a href="#cb53-267" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">result =</span> <span class="fu">map</span>(model, tidy)) <span class="sc">%&gt;%</span> </span>
<span id="cb53-268"><a href="#cb53-268" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(Region, result) <span class="sc">%&gt;%</span> </span>
<span id="cb53-269"><a href="#cb53-269" aria-hidden="true" tabindex="-1"></a>   <span class="fu">unnest</span>(<span class="at">cols =</span> result)</span>
<span id="cb53-270"><a href="#cb53-270" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-271"><a href="#cb53-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-272"><a href="#cb53-272" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>提取模型诊断信息</span>
<span id="cb53-273"><a href="#cb53-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-276"><a href="#cb53-276" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-277"><a href="#cb53-277" aria-hidden="true" tabindex="-1"></a>by_region <span class="sc">%&gt;%</span> </span>
<span id="cb53-278"><a href="#cb53-278" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">result =</span> <span class="fu">map</span>(model, glance)) <span class="sc">%&gt;%</span> </span>
<span id="cb53-279"><a href="#cb53-279" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(Region, result) <span class="sc">%&gt;%</span> </span>
<span id="cb53-280"><a href="#cb53-280" aria-hidden="true" tabindex="-1"></a>   <span class="fu">unnest</span>(<span class="at">cols =</span> result)</span>
<span id="cb53-281"><a href="#cb53-281" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-282"><a href="#cb53-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-283"><a href="#cb53-283" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>批量增加预测值、残差列等</span>
<span id="cb53-284"><a href="#cb53-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-287"><a href="#cb53-287" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-288"><a href="#cb53-288" aria-hidden="true" tabindex="-1"></a>by_region <span class="sc">%&gt;%</span> </span>
<span id="cb53-289"><a href="#cb53-289" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">result =</span> <span class="fu">map</span>(model, augment)) <span class="sc">%&gt;%</span> </span>
<span id="cb53-290"><a href="#cb53-290" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(Region, result) <span class="sc">%&gt;%</span> </span>
<span id="cb53-291"><a href="#cb53-291" aria-hidden="true" tabindex="-1"></a>   <span class="fu">unnest</span>(<span class="at">cols =</span> result)</span>
<span id="cb53-292"><a href="#cb53-292" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-293"><a href="#cb53-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-294"><a href="#cb53-294" aria-hidden="true" tabindex="-1"></a><span class="fu">## 利用rowwise技术</span></span>
<span id="cb53-295"><a href="#cb53-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-296"><a href="#cb53-296" aria-hidden="true" tabindex="-1"></a>rowwise按行方式操作数据，可以理解为一种特殊的分组：每一行为一组</span>
<span id="cb53-297"><a href="#cb53-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-300"><a href="#cb53-300" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-301"><a href="#cb53-301" aria-hidden="true" tabindex="-1"></a>by_region <span class="ot">&lt;-</span> ecostats <span class="sc">%&gt;%</span> </span>
<span id="cb53-302"><a href="#cb53-302" aria-hidden="true" tabindex="-1"></a>   <span class="fu">nest_by</span>(Region)</span>
<span id="cb53-303"><a href="#cb53-303" aria-hidden="true" tabindex="-1"></a>by_region  <span class="co"># 增加了按行惭怍的分组信息：Rowwise:Region</span></span>
<span id="cb53-304"><a href="#cb53-304" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-305"><a href="#cb53-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-306"><a href="#cb53-306" aria-hidden="true" tabindex="-1"></a><span class="in">`nest_by()`</span>将一个省份的数据放在同一行中嵌套，正好契合rowwise的逻辑，即逐行的对每个嵌套的数据框进行建模和提取模型信息的操作，这些操作使用<span class="in">`mutate()`</span>和<span class="in">`summarise()`</span>连用来实现，前者会保持rowwise模式（计算结果行数保持不变），而后者相当于对每行结果做汇总，结果行数可变（变多，且结果不具有rowwise模式）。</span>
<span id="cb53-307"><a href="#cb53-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-310"><a href="#cb53-310" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-311"><a href="#cb53-311" aria-hidden="true" tabindex="-1"></a>by_region <span class="ot">&lt;-</span> by_region <span class="sc">%&gt;%</span> </span>
<span id="cb53-312"><a href="#cb53-312" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">list</span>(<span class="fu">lm</span>(Consumption <span class="sc">~</span> gdpPercap, data)))</span>
<span id="cb53-313"><a href="#cb53-313" aria-hidden="true" tabindex="-1"></a>by_region</span>
<span id="cb53-314"><a href="#cb53-314" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-315"><a href="#cb53-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-316"><a href="#cb53-316" aria-hidden="true" tabindex="-1"></a>批量建模后，使用模型列和数据列对模型的检验统计量进行计算:</span>
<span id="cb53-317"><a href="#cb53-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-318"><a href="#cb53-318" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>使用mutate:</span>
<span id="cb53-319"><a href="#cb53-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-322"><a href="#cb53-322" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-323"><a href="#cb53-323" aria-hidden="true" tabindex="-1"></a>by_region <span class="sc">%&gt;%</span> </span>
<span id="cb53-324"><a href="#cb53-324" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(</span>
<span id="cb53-325"><a href="#cb53-325" aria-hidden="true" tabindex="-1"></a>      <span class="at">rmse =</span> <span class="fu">rmse</span>(model, data),</span>
<span id="cb53-326"><a href="#cb53-326" aria-hidden="true" tabindex="-1"></a>      <span class="at">rsq =</span> <span class="fu">rsquare</span>(model, data),</span>
<span id="cb53-327"><a href="#cb53-327" aria-hidden="true" tabindex="-1"></a>      <span class="at">slope =</span> <span class="fu">coef</span>(model)[[<span class="dv">2</span>]],</span>
<span id="cb53-328"><a href="#cb53-328" aria-hidden="true" tabindex="-1"></a>      <span class="at">pval =</span> <span class="fu">glance</span>(model)<span class="sc">$</span>p.value</span>
<span id="cb53-329"><a href="#cb53-329" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb53-330"><a href="#cb53-330" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-331"><a href="#cb53-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-332"><a href="#cb53-332" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>使用broom：</span>
<span id="cb53-333"><a href="#cb53-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-336"><a href="#cb53-336" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-337"><a href="#cb53-337" aria-hidden="true" tabindex="-1"></a>by_region <span class="sc">%&gt;%</span> </span>
<span id="cb53-338"><a href="#cb53-338" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarise</span>(<span class="fu">tidy</span>(model))</span>
<span id="cb53-339"><a href="#cb53-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-340"><a href="#cb53-340" aria-hidden="true" tabindex="-1"></a>by_region <span class="sc">%&gt;%</span> </span>
<span id="cb53-341"><a href="#cb53-341" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarise</span>(<span class="fu">glance</span>(model))</span>
<span id="cb53-342"><a href="#cb53-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-343"><a href="#cb53-343" aria-hidden="true" tabindex="-1"></a>by_region <span class="sc">%&gt;%</span> </span>
<span id="cb53-344"><a href="#cb53-344" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarise</span>(<span class="fu">augment</span>(model))</span>
<span id="cb53-345"><a href="#cb53-345" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-346"><a href="#cb53-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-347"><a href="#cb53-347" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">（分组）滚动回归</span><span class="co">](.todo)</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>